<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–£—á—ë—Ç –≥–æ—Ç–æ–≤—ã—Ö –æ–±—Ä–∞–∑—Ü–æ–≤</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h1, h2 {
      text-align: center;
    }
    .filters {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    input, select, button {
      padding: 8px;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #f8f9fa;
    }
    .actions {
      display: flex;
      gap: 5px;
    }
    .btn {
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    .btn-edit { background: #3498db; color: white; }
    .btn-delete { background: #e74c3c; color: white; }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }
    textarea {
      width: 100%;
      height: 180px;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      margin: 10px 0;
      box-sizing: border-box;
    }
    label {
      display: block;
      margin-top: 20px;
      font-weight: bold;
    }
    .selected-info {
      background: #e8f5e8;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>–£—á—ë—Ç –≥–æ—Ç–æ–≤—ã—Ö –æ–±—Ä–∞–∑—Ü–æ–≤</h1>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filters">
      <input type="date" id="startDate" placeholder="–° –¥–∞—Ç—ã">
      <input type="date" id="endDate" placeholder="–ü–æ –¥–∞—Ç—É">
      <button onclick="loadSamples()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <a id="exportLink" class="btn" style="text-decoration: none; background: #27ae60; color: white; padding: 8px 16px; border-radius: 4px;" href="#">üì• –°–∫–∞—á–∞—Ç—å Excel</a>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <div class="form-grid" id="addForm">
      <input type="text" id="article" placeholder="–ê—Ä—Ç–∏–∫—É–ª">
      <input type="text" id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
      <select id="brand">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¢–ú</option>
        <option value="PANNA">PANNA</option>
        <option value="KLART">KLART</option>
        <option value="MIADOLLA">MIADOLLA</option>
        <option value="FREYA">FREYA</option>
      </select>
      <select id="category">
        <option value="–õ–µ–æ–Ω–∞—Ä–¥–æ">–õ–µ–æ–Ω–∞—Ä–¥–æ</option>
        <option value="–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</option>
        <option value="–£—Ç–∏–ª—å">–£—Ç–∏–ª—å</option>
      </select>
      <input type="text" id="condition" placeholder="–°–æ—Å—Ç–æ—è–Ω–∏–µ">
      <input type="text" id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
      <input type="file" id="photo" accept="image/*">
      <input type="text" id="responsible" placeholder="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π">
      <input type="date" id="date">
      <button onclick="addSample()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <div id="tableContainer"></div>

    <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ -->
    <div class="selected-info" id="selectedInfo" style="display: none;">
      –í—ã–±—Ä–∞–Ω–æ: <span id="selectedCount">0</span> –∑–∞–ø–∏—Å–µ–π
      <button onclick="clearSelection()">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
    </div>

    <!-- –®–∞–±–ª–æ–Ω—ã –ø–∏—Å–µ–º -->
    <label>–ü–∏—Å—å–º–æ –ø—Ä–∏ –ø—Ä–∏—ë–º–∫–µ –æ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</label>
    <textarea id="letter1" readonly></textarea>

    <label>–ü–∏—Å—å–º–æ –æ –±—Ä–∞–∫–µ / –∏–∑–Ω–æ—Å–µ</label>
    <textarea id="letter2" readonly></textarea>

    <label>–ü–∏—Å—å–º–æ –∞—Ä—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä—É –æ —Ä–µ–º–æ–Ω—Ç–µ</label>
    <textarea id="letter3" readonly></textarea>

    <label>–ü–∏—Å—å–º–æ –≤ –ª–æ–≥–∏—Å—Ç–∏–∫—É (–∫–æ—Ä–æ–±–∞)</label>
    <textarea id="letter4" readonly></textarea>

    <button onclick="fillLetters()">üîÑ –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø–∏—Å—å–º–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –∞—Ä—Ç–∏–∫—É–ª–∞–º–∏</button>
  </div>

  <script>
    let samples = [];
    let selectedIds = new Set();

    function formatDate(dateStr) {
      return dateStr ? dateStr.split('T')[0] : '';
    }

    function loadSamples() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const url = `/api/samples?startDate=${start}&endDate=${end}`;
      fetch(url)
        .then(r => r.json())
        .then(data => {
          samples = data;
          renderTable();
          updateExportLink();
        });
    }

    function renderTable() {
      let html = `<table><thead><tr>
        <th><input type="checkbox" id="selectAll" onchange="toggleAll(this.checked)"></th>
        <th>–ê—Ä—Ç–∏–∫—É–ª</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¢–ú</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–°–æ—Å—Ç–æ—è–Ω–∏–µ</th>
        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr></thead><tbody>`;
      samples.forEach(s => {
        const checked = selectedIds.has(s.id) ? 'checked' : '';
        html += `<tr>
          <td><input type="checkbox" ${checked} onchange="toggleRow(${s.id}, this.checked)"></td>
          <td>${s.article || ''}</td>
          <td>${s.name || ''}</td>
          <td>${s.brand || ''}</td>
          <td>${s.category || ''}</td>
          <td>${s.condition || ''}</td>
          <td>${s.comment || ''}</td>
          <td>${s.responsible || ''}</td>
          <td>${formatDate(s.date)}</td>
          <td class="actions">
            <button class="btn btn-edit" onclick="editSample(${s.id})">‚úèÔ∏è</button>
            <button class="btn btn-delete" onclick="deleteSample(${s.id})">üóëÔ∏è</button>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('tableContainer').innerHTML = html;
      updateSelectionInfo();
    }

    function toggleAll(checked) {
      selectedIds.clear();
      if (checked) {
        samples.forEach(s => selectedIds.add(s.id));
      }
      renderTable();
    }

    function toggleRow(id, checked) {
      if (checked) {
        selectedIds.add(id);
      } else {
        selectedIds.delete(id);
      }
      updateSelectionInfo();
    }

    function updateSelectionInfo() {
      const count = selectedIds.size;
      document.getElementById('selectedCount').textContent = count;
      document.getElementById('selectedInfo').style.display = count > 0 ? 'block' : 'none';
    }

    function clearSelection() {
      selectedIds.clear();
      renderTable();
    }

    function addSample() {
      const formData = new FormData();
      formData.append('article', document.getElementById('article').value);
      formData.append('name', document.getElementById('name').value);
      formData.append('brand', document.getElementById('brand').value);
      formData.append('category', document.getElementById('category').value);
      formData.append('condition', document.getElementById('condition').value);
      formData.append('comment', document.getElementById('comment').value);
      formData.append('responsible', document.getElementById('responsible').value);
      formData.append('date', document.getElementById('date').value);
      
      const photoInput = document.getElementById('photo');
      if (photoInput.files.length > 0) {
        formData.append('photo', photoInput.files[0]);
      }

      fetch('/api/samples', { method: 'POST', body: formData })
        .then(() => {
          loadSamples();
          document.querySelectorAll('input, select').forEach(el => {
            if (el.type !== 'checkbox') el.value = '';
          });
          document.getElementById('photo').value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ —Ñ–∞–π–ª–∞
        });
    }

    function deleteSample(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
      fetch(`/api/samples/${id}`, { method: 'DELETE' })
        .then(() => loadSamples());
    }

    function editSample(id) {
      alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ MVP —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ —É–¥–∞–ª–µ–Ω–∏–µ + –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ.');
    }

    function updateExportLink() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const url = `/api/export-excel?startDate=${start}&endDate=${end}`;
      document.getElementById('exportLink').href = url;
    }

    function fillLetters() {
      if (selectedIds.size === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–ø–∏—Å—å');
        return;
      }

      const selected = samples.filter(s => selectedIds.has(s.id));
      const lines = selected.map(s => `‚Äî [${s.article}] ${s.name} ‚Äî ${s.condition || '–±–µ–∑ –¥–µ—Ñ–µ–∫—Ç–æ–≤'}`).join('\n');

      document.getElementById('letter1').value = `–î–æ–±—Ä—ã–π –¥–µ–Ω—å!

–°–µ–≥–æ–¥–Ω—è –ø–æ–ª—É—á–µ–Ω—ã –∏ –ø—Ä–∏–Ω—è—Ç—ã —Å–ª–µ–¥—É—é—â–∏–µ –≥–æ—Ç–æ–≤—ã–µ –æ–±—Ä–∞–∑—Ü—ã:
${lines}

–í—Å–µ –æ–±—Ä–∞–∑—Ü—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –∏ –∑–∞–Ω–µ—Å–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É —É—á—ë—Ç–∞.

–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
[–§–ò–û –æ—Ñ–æ—Ä–º–∏—Ç–µ–ª—è]
–û—Ç–¥–µ–ª –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è`;

      document.getElementById('letter2').value = `–î–æ–±—Ä—ã–π –¥–µ–Ω—å!

–ü—Ä–∏ –ø—Ä–∏—ë–º–∫–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:

${lines}

–ü—Ä–æ—Å—å–±–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å:
‚Äî –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ,
‚Äî –∏–ª–∏ —Å–ø–∏—Å–∞–Ω–∏–µ —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º –±—Ä–∞–∫–æ–≤–∞–Ω–∏–µ–º –≤ –¢–ò–°.

–ü—Ä–∏–ª–∞–≥–∞—é —Ñ–æ—Ç–æ –∏ —Ç–∞–±–ª–∏—Ü—É.

–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
[–§–ò–û –æ—Ñ–æ—Ä–º–∏—Ç–µ–ª—è]`;

      document.getElementById('letter3').value = `–î–æ–±—Ä—ã–π –¥–µ–Ω—å!

–û–±—Ä–∞–∑—Ü—ã —Ç—Ä–µ–±—É—é—Ç —Ä–µ–º–æ–Ω—Ç–∞ –ø–æ –ø—Ä–∏—á–∏–Ω–µ: [–ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ].

${lines}

–ü—Ä–∏–ª–∞–≥–∞—é —Ñ–æ—Ç–æ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é.
–ü—Ä–æ—à—É –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –≤ –≥—Ä—É–ø–ø—É –ú–ö –Ω–∞ —Ä–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ–º–æ–Ω—Ç–∞ –∏–ª–∏ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑—Ü–∞.

–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
[–§–ò–û –æ—Ñ–æ—Ä–º–∏—Ç–µ–ª—è]`;

      document.getElementById('letter4').value = `–î–æ–±—Ä—ã–π –¥–µ–Ω—å, –ì—Ä–∏–≥–æ—Ä–∏–π!

–í—ã—Å—ã–ª–∞—é —Ç–∞–±–ª–∏—Ü—É —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –∫–æ—Ä–æ–±–æ–≤ –¥–ª—è –≤—ã—Å—Ç–∞–≤–∫–∏:
‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–≤: [N]
‚Äî –≤–ª–æ–∂–µ–Ω–∏–µ: [–Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞]

–°–ø–∏—Å–æ–∫ –æ–±—Ä–∞–∑—Ü–æ–≤:
${lines}

–ü—Ä–æ—Å—å–±–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —è—Ä–ª—ã–∫–∏ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –¥–∞—Ç—É –ø–æ–≥—Ä—É–∑–∫–∏.

–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
[–§–ò–û –æ—Ñ–æ—Ä–º–∏—Ç–µ–ª—è]`;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadSamples();
  </script>
</body>
</html>
