<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Kaiten Addon</title>
  <script src="https://files.kaiten.ru/web-sdk/v1.min.js"></script>
  <script>
    if (window.Addon) {
      window.Addon.initialize({
        card_buttons: function() {
          return [{
            text: 'üì§ –í—ã–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —É—á—ë—Ç–∞',
            callback: function(ctx) {
              const userEmail = ctx.user.email;
              const allowedDomains = ['panna.ru', 'firma-gamma.ru', 'sb-service.ru'];
              const userDomain = userEmail.split('@')[1];

              if (!allowedDomains.includes(userDomain)) {
                alert('–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –∫–æ–º–ø–∞–Ω–∏–∏.');
                return;
              }

              fetch('https://kaiten-samples-addon.onrender.com/api/export-sample-table', {
                method: 'GET',
                headers: { 'X-User-Email': userEmail }
              })
              .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                return response.blob();
              })
              .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `–¢–∞–±–ª–∏—Ü–∞_—É—á—ë—Ç–∞_–æ–±—Ä–∞–∑—Ü–æ–≤_${new Date().toISOString().slice(0,10)}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∏—Å—å–º–æ
                const subject = encodeURIComponent('–¢–∞–±–ª–∏—Ü–∞ —É—á—ë—Ç–∞ –≥–æ—Ç–æ–≤—ã—Ö –æ–±—Ä–∞–∑—Ü–æ–≤');
                const body = encodeURIComponent(
                  '–î–æ–±—Ä—ã–π –¥–µ–Ω—å!\n\n–í–æ –≤–ª–æ–∂–µ–Ω–∏–∏ ‚Äî —à–∞–±–ª–æ–Ω —Ç–∞–±–ª–∏—Ü—ã —É—á—ë—Ç–∞ –≥–æ—Ç–æ–≤—ã—Ö –æ–±—Ä–∞–∑—Ü–æ–≤ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,'
                );
                window.open(`mailto:${userEmail}?subject=${subject}&body=${body}`);
              })
              .catch(err => {
                console.error(err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
              });
            }
          }];
        }
      });
    }
  </script>
</head>
<body></body>
</html>
